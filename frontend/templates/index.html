
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGLM iOS æ§åˆ¶å°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .container { max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; flex-grow: 1; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #007aff; color: white; padding: 15px; text-align: center; font-weight: bold; }
        .log-area { flex-grow: 1; padding: 15px; overflow-y: auto; font-family: monospace; font-size: 14px; background: #fafafa; border-bottom: 1px solid #eee; white-space: pre-wrap; }
        .history-header { padding: 5px 15px; font-size: 12px; color: #888; background: #f8f9fa; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .history-area { padding: 8px 15px; background: #fff; max-height: 100px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 1px solid #eee; }
        .history-item { background: #e9ecef; color: #495057; padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; transition: background 0.2s; white-space: nowrap; border: 1px solid #dee2e6; }
        .history-item:hover { background: #dee2e6; }
        .clear-btn { color: #007aff; cursor: pointer; text-decoration: none; font-size: 11px; }
        .input-area { padding: 15px; display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        button { padding: 10px 20px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .think { color: #666; font-style: italic; border-left: 3px solid #ddd; padding-left: 10px; margin: 10px 0; }
        .action { color: #007aff; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">AutoGLM iOS ç§»åŠ¨ç«¯æ§åˆ¶å°</div>
        <div id="logs" class="log-area">ç­‰å¾…æŒ‡ä»¤...</div>
        <div id="historySection" style="display: none;">
            <div class="history-header">
                <span>å†å²è®°å½•</span>
                <span class="clear-btn" onclick="clearHistory()">æ¸…ç©º</span>
            </div>
            <div id="history" class="history-area"></div>
        </div>
        <div class="input-area">
            <input type="text" id="taskInput" placeholder="è¾“å…¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šæ‰“å¼€å¾®ä¿¡">
            <button id="sendBtn" onclick="sendTask()">è¿è¡Œ</button>
        </div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const historyDiv = document.getElementById('history');
        const historySection = document.getElementById('historySection');
        const input = document.getElementById('taskInput');
        const btn = document.getElementById('sendBtn');
        let currentLogDiv = null;

        // Load task history on startup
        let taskHistory = [];
        fetchHistory();

        async function fetchHistory() {
            try {
                const response = await fetch('/api/history');
                if (response.ok) {
                    const data = await response.json();
                    taskHistory = data.map(t => t.task_description);
                    renderHistory();
                }
            } catch (err) {
                console.error("Failed to fetch history:", err);
            }
        }

        function renderHistory() {
            console.log("Rendering history:", taskHistory);
            if (!taskHistory || taskHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            historySection.style.display = 'block';
            historyDiv.innerHTML = '';
            // Show unique tasks in reverse order
            const uniqueHistory = [...new Set(taskHistory)].reverse();
            uniqueHistory.forEach(task => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = task.length > 20 ? task.substring(0, 20) + '...' : task;
                item.title = task;
                item.onclick = (e) => {
                    e.preventDefault();
                    input.value = task;
                    sendTask();
                };
                historyDiv.appendChild(item);
            });
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ')) {
                // For now just clear local UI, real backend clear could be added
                taskHistory = [];
                renderHistory();
            }
        }

        function saveToHistory(task) {
            // Backend saves automatically on /run
            if (!task) return;
            taskHistory = taskHistory.filter(t => t !== task);
            taskHistory.push(task);
            renderHistory();
        }

        function appendLog(text) {
            // If it's a special marker, create a new div
            if (text.includes('ğŸš€') || text.includes('ğŸ’­') || text.includes('ğŸ¯') || text.includes('âœ…') || text.includes('ğŸ') || text.includes('â±ï¸') || text.includes('Parsing action:')) {
                currentLogDiv = document.createElement('div');
                if (text.includes('ğŸ’­')) currentLogDiv.className = 'think';
                else if (text.includes('ğŸ¯')) currentLogDiv.className = 'action';
                else if (text.includes('âœ…')) currentLogDiv.className = 'success';
                
                currentLogDiv.textContent = text;
                logsDiv.appendChild(currentLogDiv);
            } else {
                // If no current div or last one was special, create a plain one
                if (!currentLogDiv) {
                    currentLogDiv = document.createElement('div');
                    logsDiv.appendChild(currentLogDiv);
                }
                // Append text to existing div (handle the streaming feel)
                currentLogDiv.textContent += text;
            }
            
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function sendTask() {
            const task = input.value.trim();
            if (!task) return;

            input.value = '';
            btn.disabled = true;
            logsDiv.innerHTML = '';
            appendLog('ğŸš€ ä»»åŠ¡å¯åŠ¨: ' + task);
            saveToHistory(task);

            const response = await fetch('/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task })
            });

            if (response.ok) {
                const eventSource = new EventSource('/logs');
                eventSource.onmessage = function(event) {
                    if (event.data === 'END') {
                        eventSource.close();
                        btn.disabled = false;
                        appendLog('ğŸ è¿è¡Œç»“æŸ');
                    } else {
                        appendLog(event.data);
                    }
                };
            } else {
                appendLog('âŒ å¯åŠ¨å¤±è´¥');
                btn.disabled = false;
            }
        }

        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                btn.click();
            }
        });
    </script>
</body>
</html>
