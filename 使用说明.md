# Phone-Agent-Web 使用说明

## 🎯 系统概述

Phone-Agent-Web 是一个基于 Vue 3 + Flask 的 iOS/Android 自动化测试平台，通过 WebDriverAgent 和 AI 模型实现自然语言控制手机。

---

## 🚀 快速开始

### 1. 启动 WebDriverAgent

```bash
# 方法 1：使用 Xcode
cd /Users/jianqin/Desktop/ModelTrain/Open-GLM/WebDriverAgent
open WebDriverAgent.xcodeproj
# 在 Xcode 中选择设备并运行 WebDriverAgentRunner

# 方法 2：使用命令行
xcodebuild -project WebDriverAgent.xcodeproj \
  -scheme WebDriverAgentRunner \
  -destination "id=$(idevice_id -l | head -1)" \
  test
```

### 2. 启动端口转发

```bash
# 在新终端窗口运行
iproxy 8100 8100
```

### 3. 启动后端服务

```bash
cd /Users/jianqin/Desktop/ModelTrain/Open-GLM/Phone-Agent-Web
python3 run.py
```

### 4. 启动前端服务

```bash
cd /Users/jianqin/Desktop/ModelTrain/Open-GLM/Phone-Agent-Web/frontend-vue
npm run dev
```

### 5. 访问前端

打开浏览器访问：`http://localhost:5173`

---

## 📱 功能说明

### 首页 (/)
- 功能入口导航
- 快速开始指南
- 系统介绍

### 设备管理 (/devices)

#### 设备列表
- 显示已连接的 iOS/Android 设备
- 设备信息：名称、型号、系统版本、在线状态
- 刷新按钮：重新加载设备列表

#### 任务执行
1. **输入任务指令**
   - 使用自然语言描述任务
   - 例如："打开微信，并且点击通讯录"
   - 例如："打开设置"

2. **执行任务**
   - 点击"执行任务"按钮
   - 系统会自动：
     - 连接日志流
     - 调用 AI 模型分析任务
     - 通过 WDA 控制手机执行操作
     - 实时显示执行过程

3. **查看日志**
   - 实时显示执行日志
   - 颜色区分不同类型的日志：
     - 🟢 绿色：完成、成功
     - 🔴 红色：错误、失败
     - 🔵 蓝色：AI 思考
     - 🟡 黄色：开始执行
     - 🟣 紫色：分析过程
     - 🔷 青色：执行动作
   - 自动滚动到最新日志

4. **停止任务**
   - 点击"停止"按钮中断执行

### 执行历史 (/history)
- 查看所有任务的执行记录
- 任务状态：运行中、已完成、失败
- 执行时间和结果详情
- 刷新按钮：更新历史记录

---

## 🎨 日志显示说明

执行任务时，日志会实时显示执行过程：

```
[17:30:00] 📝 开始执行任务: 打开微信
[17:30:00] ✅ Agent 已初始化
[17:30:00] 🤖 正在调用 AI 模型分析任务...
[17:30:02] 💭 用户要求打开微信应用...
[17:30:05] 🎯 执行动作: Launch(app="微信")
[17:30:10] ✅ 任务执行完成
[17:30:10] 📊 结果: 已成功打开微信！
[17:30:10] ✅ 任务执行结束
```

---

## ⚙️ 配置说明

### 后端配置 (backend/config.py)

```python
class Config:
    # AI 模型配置
    MODEL_BASE_URL = "https://open.bigmodel.cn/api/paas/v4"
    MODEL_API_KEY = "your-api-key"
    MODEL_NAME = "autoglm-phone"
    
    # Agent 配置
    WDA_URL = "http://localhost:8100"
    DEFAULT_LANG = "cn"
    
    # 服务器配置
    PORT = 5001
    HOST = '0.0.0.0'
```

### 前端配置 (frontend-vue/src/api/index.js)

```javascript
const API_BASE_URL = 'http://localhost:5001'
```

---

## 🔧 常见问题

### Q1: 日志只显示一个数字或乱码

**原因**：日志流连接时机不对或数据格式问题

**解决方案**：
1. 刷新页面
2. 确保在点击"执行任务"前页面已完全加载
3. 查看浏览器控制台是否有错误

### Q2: 任务一直显示"运行中"

**原因**：
- AI 模型 API 调用失败
- WebDriverAgent 连接中断
- 后端进程崩溃

**解决方案**：
1. 检查后端日志
2. 重启后端服务
3. 检查 WDA 是否正常运行
4. 查看执行历史中的错误信息

### Q3: 设备列表为空

**原因**：
- iOS 设备未连接
- WebDriverAgent 未运行
- iproxy 未启动

**解决方案**：
1. 确保设备通过 USB 连接
2. 启动 WebDriverAgent
3. 启动 iproxy 端口转发
4. 点击"刷新"按钮

### Q4: 手机没有响应

**原因**：
- WDA 会话过期
- 设备锁屏
- 任务指令不明确

**解决方案**：
1. 重启 WebDriverAgent
2. 解锁设备
3. 使用更明确的任务指令
4. 查看执行历史中的错误信息

---

## 📊 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                     用户浏览器                           │
│              http://localhost:5173                      │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/SSE
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  Flask 后端 API                          │
│              http://127.0.0.1:5001                      │
│  - /api/devices  (设备列表)                              │
│  - /run          (执行任务)                              │
│  - /api/history  (执行历史)                              │
│  - /logs         (实时日志流)                            │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              Phone Agent (AI 控制)                       │
│  - AI 模型分析任务                                        │
│  - 生成执行计划                                           │
│  - 调用 WDA 控制设备                                      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│         WebDriverAgent (设备控制)                        │
│              http://localhost:8100                      │
│  - 截图                                                  │
│  - 点击、滑动、输入                                       │
│  - 启动应用                                               │
└────────────────────┬────────────────────────────────────┘
                     │ USB/iproxy
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  iOS/Android 设备                        │
└─────────────────────────────────────────────────────────┘
```

---

## 📝 开发说明

### 技术栈

**前端**：
- Vue 3 (Composition API)
- Vue Router 4
- TailwindCSS 3.4
- Lucide Icons
- Vite 7

**后端**：
- Flask
- SQLAlchemy
- Flask-CORS
- OpenAI SDK (AI 模型调用)

**设备控制**：
- WebDriverAgent (iOS)
- Phone Agent (AI 控制层)

### 项目结构

```
Phone-Agent-Web/
├── frontend-vue/          # Vue 3 前端
│   ├── src/
│   │   ├── api/          # API 接口
│   │   ├── views/        # 页面组件
│   │   ├── router/       # 路由配置
│   │   └── assets/       # 静态资源
│   └── package.json
├── backend/              # Flask 后端
│   ├── app.py           # 主应用
│   ├── config.py        # 配置
│   └── models.py        # 数据模型
├── database/            # SQLite 数据库
└── run.py              # 启动脚本
```

---

## 🎯 下一步计划

- [ ] 添加测试用例管理功能
- [ ] 支持批量任务执行
- [ ] 添加设备截图预览
- [ ] 支持 Android 设备
- [ ] 优化 AI 模型提示词
- [ ] 添加任务调度功能
- [ ] 支持多设备并发控制

---

**版本**：v1.0  
**更新日期**：2026-01-05  
**作者**：Phone-Agent-Web Team
